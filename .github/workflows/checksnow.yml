name: Check Snow Water Equivalent

on:
  schedule:
    # Run daily at 06:00 Mountain Time (13:00 UTC)
    - cron: '0 13 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write

jobs:
  check-snow:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Fetch snow data and extract SWE with Copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read instructions from copilot-instructions.md
          INSTRUCTIONS=$(cat .github/copilot-instructions.md)
          
          # Fetch the webpage
          curl -s "https://www.nwrfc.noaa.gov/snow/snowplot.cgi?ISPI1" \
            > snow_page.html
          
          # Use GitHub Copilot with instructions from the file
          SWE=$(gh copilot suggest -t shell "$INSTRUCTIONS" \
            | grep -oP '\d+\.\d+|\d+' | head -1)
          
          # Get timestamp
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          # Create or update the data file
          echo "Last Updated: $TIMESTAMP" > snow_data.txt
          echo "Snow Water Equivalent: $SWE inches" >> snow_data.txt
          echo "Station: Island Park (ISPI1)" >> snow_data.txt
          echo "Source: https://www.nwrfc.noaa.gov/snow/snowplot.cgi?ISPI1" \
            >> snow_data.txt
          
          cat snow_data.txt
      
      - name: Commit and push if changed
        run: |
          git config --local user.email \
            "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add snow_data.txt
          git diff --staged --quiet \
            || git commit -m "Update snow water equivalent data"
          git push
